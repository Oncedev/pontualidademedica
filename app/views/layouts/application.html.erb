<!DOCTYPE html>
<html>
<head>
  <title>Pontualidade Médica</title>
  <%= stylesheet_link_tag    "jquery.datetimepicker", media: "all", "data-turbolinks-track" => true %>
  <%= stylesheet_link_tag    "application", media: "all", "data-turbolinks-track" => true %>
  <%= stylesheet_link_tag    "simple_animation", media: "all", "data-turbolinks-track" => true %>

  <%= javascript_include_tag "application", "data-turbolinks-track" => true %>

  <%= csrf_meta_tags %>
 
</head>
<body>

    <!--=================================================-->
    <header class="header_batimento">

        <%= image_tag("logo.png", :id => "logo") %>

    </header>
    <!--=================================================-->

    <!--=================================================--> 
    <!-- Se não estiver logado some a barra sair-->
    <% if !session[:usuario].nil? %>

       <div id="barra_sair">
         <b class="nome_usuario">Logado como <%= session[:usuario].nome %></b>  <b><%= link_to "Sair", controller: "usuarios", action: "logout" %></b>
       </div><!--end sair--> 

    <% end %>
    <!--=================================================-->

    <div id="whapper">

        <!--=================================================-->
        <section id="pesquisa">
          <div id="pesquisa_center">
            <ul id="menu_desktop">
                <li>
                    <%= link_to "Início", controller: "medicos", action: "index" %>
                </li>
              <!-- se estiver logado some button adastro e apresenta button nova consulta-->
               <% if session[:usuario].nil? %>
                <li>
                    <%= link_to "Cadastre-se", controller: "usuarios", action: "new" %>
                </li>
               <% else %>
                <li>
                    <%= link_to "Nova consulta", controller: "consultas", action: "new" %>
                </li>
               <% end %>

              <!-- se estiver logado some button login -->
               <% if session[:usuario].nil? %>
                <li>
                  <%= link_to "Login", controller: "usuarios", action: "login" %>
                </li>
               <% end %>


              </ul>

           
          
            <form method="post" action="post">
                <table>
                    <tr>
                      <td> <input type="text" id="pesquisa_crm" placeholder="Nome ou CRM..."/> </td>
                      <td> <button type="button" id="button_pesquisar">Buscar</button>
                      </tr>
                  </table>
              </form>
              <div id="none"></div>
          </div><!--end pesquisa center-->
          </section>

          <%= yield %>

      </div>

      <script type="text/javascript">
        $(document).ready(function() {
            $("#button_pesquisar").click(function() {

                var area = document.querySelector('#whapper_conteudo table');
                area.innerHTML = "";

                $.ajax({

                  url: "medicos.json",
                  data: {CRM_ou_nome: $("#pesquisa_crm").val()},
                  complete: function( data ) {

                      var meuJSON = JSON.parse( data.responseText );                      

                      for ( var cont = 0; cont < meuJSON.length; cont++ ) {
                       
                       var passaMinutosParaHoras = Math.floor( meuJSON[ cont ].atraso_medio / 60 ),
                           resto = meuJSON[ cont ].atraso_medio % 60,
                           saidaAtrasoFormato = null;

                           if ( passaMinutosParaHoras < 1 ) {
                                saidaAtrasoFormato = meuJSON[ cont ].atraso_medio + ' m ';
                           }

                           else {
                               saidaAtrasoFormato = passaMinutosParaHoras + ' h ' + resto;
                           }

                          

                         area.innerHTML += 

                         '<tr>' +
                         '<td>' + meuJSON[ cont ].CRM + '</td>' +
                         '<td>' + meuJSON[ cont ].nome + '</td>' +
                         '<td>' + saidaAtrasoFormato + '</td>'+
                         '</tr>'
                     }                     
                 }
             });

                 
            });
        });
    </script>

</body>
</html>
